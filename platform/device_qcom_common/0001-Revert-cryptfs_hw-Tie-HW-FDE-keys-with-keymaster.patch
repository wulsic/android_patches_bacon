From ba5ec4507420fcd318e22bf5e99ed713d2d43817 Mon Sep 17 00:00:00 2001
From: Hamster Tian <haotia@gmail.com>
Date: Thu, 25 Aug 2016 18:47:29 +0800
Subject: [PATCH 1/4] Revert "cryptfs_hw: Tie HW FDE keys with keymaster"

This reverts commit 12f03229933a6608f5bfde45a491a8ceea6f58e6.
---
 cryptfs_hw/Android.mk   |  5 +----
 cryptfs_hw/cryptfs_hw.c | 37 -------------------------------------
 cryptfs_hw/cryptfs_hw.h |  1 -
 3 files changed, 1 insertion(+), 42 deletions(-)

diff --git a/cryptfs_hw/Android.mk b/cryptfs_hw/Android.mk
index 207726d..73160d6 100644
--- a/cryptfs_hw/Android.mk
+++ b/cryptfs_hw/Android.mk
@@ -10,10 +10,7 @@ sourceFiles := \
 commonSharedLibraries := \
                         libcutils \
                         libutils \
-                        libdl \
-                        libhardware
-commonIncludes := \
-                  hardware/libhardware/include/hardware/
+                        libdl
 
 LOCAL_C_INCLUDES := $(commonIncludes)
 LOCAL_SRC_FILES := $(sourceFiles)
diff --git a/cryptfs_hw/cryptfs_hw.c b/cryptfs_hw/cryptfs_hw.c
index caaeea3..befc9e1 100755
--- a/cryptfs_hw/cryptfs_hw.c
+++ b/cryptfs_hw/cryptfs_hw.c
@@ -38,8 +38,6 @@
 #include "cutils/log.h"
 #include "cutils/properties.h"
 #include "cutils/android_reboot.h"
-#include "keymaster_common.h"
-#include "hardware.h"
 
 
 // When device comes up or when user tries to change the password, user can
@@ -64,8 +62,6 @@ static unsigned int cpu_id[] = {
 	239, /* MSM8939 SOC ID */
 };
 
-#define KEYMASTER_PARTITION_NAME "/dev/block/bootdevice/by-name/keymaster"
-
 static int loaded_library = 0;
 static int (*qseecom_create_key)(int, void*);
 static int (*qseecom_update_key)(int, void*, void*);
@@ -287,36 +283,3 @@ int is_ice_enabled(void)
   }
   return storage_type;
 }
-
-static int get_keymaster_version()
-{
-    int rc = -1;
-    const hw_module_t* mod;
-    rc = hw_get_module_by_class(KEYSTORE_HARDWARE_MODULE_ID, NULL, &mod);
-    if (rc) {
-        SLOGE("could not find any keystore module");
-        return rc;
-    }
-
-    return mod->module_api_version;
-}
-
-int should_use_keymaster()
-{
-    /* HW FDE key would be tied to keymaster only if:
-     * New Keymaster is available
-     * keymaster partition exists on the device
-     */
-    int rc = 0;
-    if (get_keymaster_version() != KEYMASTER_MODULE_API_VERSION_1_0) {
-        SLOGI("Keymaster version is not 1.0");
-        return rc;
-    }
-
-    if (access(KEYMASTER_PARTITION_NAME, F_OK) == -1) {
-        SLOGI("Keymaster partition does not exists");
-        return rc;
-    }
-
-    return 1;
-}
diff --git a/cryptfs_hw/cryptfs_hw.h b/cryptfs_hw/cryptfs_hw.h
index c443798..7596a43 100755
--- a/cryptfs_hw/cryptfs_hw.h
+++ b/cryptfs_hw/cryptfs_hw.h
@@ -40,7 +40,6 @@ int clear_hw_device_encryption_key(void);
 unsigned int is_hw_disk_encryption(const char*);
 unsigned int is_hw_fde_enabled(void);
 int is_ice_enabled(void);
-int should_use_keymaster();
 
 #ifdef __cplusplus
 }
-- 
2.1.4

